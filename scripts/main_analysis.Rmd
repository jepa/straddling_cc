---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: '2022-04-20'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(MyFunctions)

packages <- c(
  "readxl", # Read dataframe
  "data.table", # Read dataframe (Fast!)
  "wesanderson",
  "tidyverse", # for all data wrangling and ggplot
  "janitor", # for data cleaning
  "tidytext", # to order the facet wrap https://juliasilge.com/blog/reorder-within/
  "cowplot", # for figures 1 and 3
  # "ggimage", #for reading images to the circular plot
  "ggrepel", # for nice plot labels
  # "ggsflabel", # for nice sf_plots labels
  # "spdep", # for poly2nb old
  "sf", #Spatial analysis 
  "sp", #Spatial analysis 
  # "purrr",#Spatial analysis
  # "rgdal", #Spatial analysis
  "tools", #Spatial analysis 
  "parallel", # for parallelization
  "doParallel", # for parallelization
  # "taxize", # For getting species names
  "rfishbase", # for species ecosystem affinity
  "zoo", #for runing mean
  # "pgirmess", # for dune test after kurtis wallas
  "rnaturalearth", # For maps
  "R.matlab", # For Gabs distributions
  "parallel",
  "viridis",
  # Juanitos map
  "zeallot",
  "geosphere",
  # Sankey network
  "networkD3",
  "circlize"
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

# Call functions

# Needed for results 
source("./functions/get_results.R")
source("./functions/circle_figures_fx.R")

```


# Methods

1.- Get transboundary species list

1.1- Remove highly migratory species based on literature

2- High seas shapefile

2.1- FAO Areas ID

3.- Identiy what transboundary species are actually straddling 

4.- Be happy, happy like a hippo

## Data

### Shapefiles 

#### Ocean Basins

Bioms data from Gabs (Reygondea et al 2019)

```{r}
# Do analysis by ocean basin

# Bioms data from Gabs (Reygondea et al 2019)
# biome2 1 = Coastal tropical 
# biome2 2 = Coastal sub-tropical
# biome2 3 = Coastal polar
# biome2 4 = Oceanic tropical
# biome2 5 = Oceanic sub-tropical
# biome2 6 = Oceanic polar

basin_data <- my_path("Spa","gabs","ALL_META_HAB_CMIP6_LAYERS.csv", read = T) %>% 
  mutate(
    basin_name = ifelse(basin2 == 0, "w_atlantic",
                        ifelse(basin2 == 1 ,"e_atlantic",
                               ifelse(basin2 == 2, "e_pacific",
                                      ifelse(basin2 == 3, "w_pacific",
                                             ifelse(basin2 == 4, "w_indian",
                                                    ifelse(basin2 == 5,"e_indian",
                                                           ifelse(basin2 == 6,"antarctic",
                                                                  ifelse(basin2 == 7,"actic",
                                                                         NA))))))))
  ) %>% 
  select(lon = longitude,
         lat = latitude,
         basin_name) %>% 
  left_join(my_data("dbem_coords"))


# For supplemental material 

basin_sf <- st_as_sf(basin_data,
                     coords = c("lon", "lat"), crs = 4326)  # WGS84

# meow_sf <- my_sf("MEOW")

ggplot() +
  geom_sf(data = basin_sf %>% filter(!is.na(basin_name)),
          aes(
            color = as.character(basin_name)
          )
  ) +
  geom_sf(data = meow_sf %>% filter(realm == "Central Indo-Pacific"), aes(fill = realm)) +
  scale_fill_viridis_d() +
  scale_color_brewer(palette = "Set3") + 
  my_land_map(fill = "black") +
  theme(legend.background = element_blank())



# This data now substitutes rfmo_index in the analysis
ob_index <- basin_data %>% 
  filter(!index %in% dbem_meow_df$index) %>% 
  select(index,basin_name)

# DBEM to MEOW grid
meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T) %>% 
  clean_names()

# Neighboring RFMOs and MEOWs created in previous chunk on July 20
ob_meow <- my_path("G","Spatial/SAU/","ob_meow_neighbours.csv", read = T)
```

#### General shapefiles

```{r shapefiles, eval = F}

# Coordinatres DBEM
coords_dbem <- my_path("Spa","DBEM","Lon_Lat_DBEM.txt",read = T, header = F)
colnames(coords_dbem) <- c("index","lon","lat")

dbem_sf <-st_as_sf(coords_dbem,
                   coords = c("lon", "lat")
) %>% 
  st_set_crs(4326) #%>%
# st_transform(crs = "+proj=eck4")

st_crs(dbem_sf) = 4326

# EEZs
# world_eez <- my_sf("SAU",simple = 1000)

# SAU index table
sau_index_code <- my_data("sau_index")

### Get MEO to DBEM
meow_regions <- my_sf("MEOW")
st_crs(meow_regions) = 4326

meow_dbem <- st_join(dbem_sf,
                     meow_regions,
                     join = st_intersects)


# Get eez per realm
dbem_meow_df <- meow_dbem %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  clean_names() %>% 
  filter(!is.na(realm)) #Remove high seas

dbem_meow_df_supp <- dbem_meow_df %>% 
  group_by(index,realm,ecoregion) %>%
  tally() %>%
  left_join(sau_index_code) %>%
  group_by(realm,eez_name) %>%
  tally() %>% 
  filter(eez_name !="High seas") %>% 
  select(-n,
         Realm = realm,
         EEZ = eez_name)

# Save data for future analysis
# write_csv(dbem_meow_df_supp,"./results/supplements/realm_to_eez.csv")

# Check map
# dbem_meow_df_supp %>%
#   filter(eez_name=="High seas") %>%
#   left_join(coords_dbem) %>%
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = index
#     )
#   )


# RFMO regions
# RFMO data
sf_rfmo <- my_sf("RFMO") %>% 
  filter(RFMO_nm_s %in% c("ICCAT","WCPFC","IOTC","IATTC","CCSBT")) %>% 
  dplyr::rename(rfmo_name = RFMO_nm_s) %>% 
  group_by(rfmo_name) %>% 
  summarise(geometry = st_union(geometry))

st_crs(sf_rfmo) = 4326

rfmo_dbem <- st_join(dbem_sf,
                     sf_rfmo,
                     join = st_intersects)

# Select only high seas (i.e., remove waters within EEZs)
rfmo_dbem_hs <- rfmo_dbem %>% 
  as.data.frame()%>% 
  select(-geometry) %>% 
  clean_names() %>% 
  filter(!is.na(rfmo_name)) # remove areas where no tuna RFMO exists (some high seas pockets)


# Finalize data
dbem_rfmo_index <- rfmo_dbem_hs %>% 
  filter(!index %in% dbem_meow_df$index)


# dbem_rfmo_index %>%
#   left_join(coords_dbem) %>%
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = rfmo_name
#     )
#   ) +
#   geom_tile(data = dbem_meow_df %>% left_join(coords_dbem),
#     aes(
#       x = lon,
#       y = lat
#     ),
#     fill = "red"
#   )

# Save data for further analysis
# write_csv(dbem_rfmo_index, my_path("Spa", "SAU/SAU_RFMO/","RFMO_Index_Code.csv"))

## Coombine rfmo and MEOW shapefiles in one
sf_rfmo_to_combine <- sf_rfmo %>% 
  select(region = rfmo_name, geometry)

sf_meow_to_combine <- meow_regions %>% 
  select(region = realm, geometry)

sf_meow_rfmo <- rbind(sf_rfmo_to_combine, 
                      sf_meow_to_combine)


# Create index only of high seas
ob_index <- basin_data %>% 
  filter(!index %in% dbem_meow_df$index)

# ggplot(basin_data) +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = basin_name
#     )
# )


# Join both SF to run neighbours on
basin_sf <-st_as_sf(basin_data,
                    coords = c("lon", "lat")
) %>% 
  st_set_crs(4326) #%>%


# Select the MEOW SF
sf_meow_to_combine <- meow_regions %>% 
  select(region = realm, geometry)
st_crs(sf_meow_to_combine) = 4326

# Select the basin SF
sf_basin_to_combine <- basin_sf %>% 
  select(region = basin_name, geometry)
st_crs(sf_basin_to_combine) = 4326

# Join them
sf_meow_basin <- rbind(sf_basin_to_combine, 
                       sf_meow_to_combine)

unique(sf_meow_basin$region)

```


## Determine adjacent RFMOs and MEOWS

Code modified from FishForVisa

```{r funEstNeighbours, eval = F, echo=T}

Shapefile = sf_meow_basin

# Get sparse matrix
int = suppressMessages(st_intersects(Shapefile))
# Warnning message
# although coordinates are longitude/latitude, st_intersects assumes that they are planar


# Intitalize new object
mat = NULL

# Fill
for(i in 1:NROW(int)){
  #Create matrix with ID and intersecting IDs
  tmp = cbind(i, int[[i]])
  
  # Join to Initalized object
  mat  = rbind(mat, tmp)
}

# Build final data.frame substituting ID for name (in this case nc$name)
Result_table = data.frame(region = Shapefile$region[mat[,1]], 
                          adjacent_region = Shapefile$region[mat[,2]]
)

Result_table %>% group_by(region,adjacent_region) %>% tally() %>% View()

unique(Result_table$region)
unique(Result_table$adjacent_region)

# Remove duplicates... eg of course an object intersects with itself...
Result_table = Result_table[Result_table$region != Result_table$adjacent_region,]

# Get index cells within those RFMOs
rfmo_partial <- Result_table %>% 
  distinct() %>% 
  # rename(rfmo_name = region) %>% # for RFMO to MEOW analysis
  # left_join(rfmo_index, 
  # by = "rfmo_name")%>%  # for RFMO to MEOW analysis
  rename(basin_name = region) %>% 
  left_join(ob_index, 
            by = "basin_name")%>% 
  filter(!is.na(index),
         !is.na(basin_name)) %>% 
  rename(region = basin_name)

# Get index cells within those MEOWS
meow_partial <- Result_table %>% 
  distinct() %>%
  rename(realm = region) %>% 
  left_join(meow_dbem_grid, 
            by = "realm") %>% 
  filter(!is.na(index)) %>% 
  rename(region = realm)

ob_meow_final <- bind_rows(rfmo_partial,meow_partial) %>% 
  group_by(region,adjacent_region) %>% 
  tally() %>% 
  select(-n)

# If done with ocean basins data
# write_csv(ob_meow_final, my_path("G","Spatial/SAU/","ob_meow_neighbours.csv"))

# If done with RFMO data
# write_csv(ob_meow_final, my_path("G","Spatial/SAU/SAU_RFMO/","rfmo_meow_neighbours.csv"))

```

## Determining straddling stocks

### Data required

```{r}

# Do analysis by ocean basin
rfmo_index <- my_path("Spa","/SAU/SAU_RFMO/","RFMO_Index_Code.csv", read = T) 
# Neighboring RFMOs and MEOWs created in previous chunk on July 20
rfmo_meow <- my_path("G","Spatial/SAU/SAU_RFMO/","rfmo_meow_neighbours.csv", read = T)

# Gabriel's coordinate system for GetSppDist fx. data pull
CoorG <- my_path("G","FishForVisa/Data/Spatial/","coordinates_gab.csv",read =T) %>%
  mutate(INDEX = seq(1,259200,1))

# DBEM to MEOW grid needed for stradd_index fx
meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T) %>% 
  clean_names()

# Load FishForVisa Results
transboundary_spp <- read_csv("https://media.githubusercontent.com/media/jepa/FishForVisa/master/Data/Results/Clean_Results_Trans.csv") %>% 
  # Set same filters as in FishForVisa
  filter(
    area_index >= 0.25,
    area_index <= 1-0.25,
    model_index >= 100
  )

# Double check we have 633 species
length(unique(transboundary_spp$taxon_key)) # 633

#Get DBEM coords 
coords_dbem <- my_data("dbem_coords")

# Species to ran
# Check runs already made
# run_species <- list.files(my_path("R","Straddling_realm_rfmo"))
run_species <- list.files(my_path("R","straddling_realm_ob"))
run_species <- str_sub(run_species,1,6)

run_me <- transboundary_spp %>% 
  filter(!taxon_key %in% run_species) %>% 
  pull(taxon_key) %>% 
  unique()


# Get eez to rfmo region for highly migratory
eez_rfmo_region <- dbem_sf %>% 
  left_join(sau_index_code) %>% 
  filter(eez_id > 0) %>% 
  st_join(sf_meow) %>% 
  group_by(eez_name,region = realm) %>% 
  tally() %>% 
  as.data.frame() %>% 
  left_join(rfmo_meow,
            by = "region") %>% 
  select(eez_name,region,adjacent_region) %>% 
  na.omit()

write(eez_rfmo_region, my_path("D","Spatial",name = "eez_rfmo_region.csv"))

```


### Control Panel

Methodological points to consider

- RFMOs neighboring realms from the MEOW. This has now changed for Ocean Basins
- The straddling index accounts for how much of the population is present (as a %) in the ocean basin. So if it says 80%, it means that 80% of the population is present in the high seas and 20% in the realm.
- A straddling stock is herein defined as a stock that is shared between a REALM (and its EEZs) and the high sea's ocean basin


```{r run_me, eval = F}

source("./functions/stradd_index.R")
source("./functions/get_spp_dist.R")

# One species
# stradd_index(spp = 600006, # Taxon key for species
#              model = "All", # datasets to include (see transboundary work)
#              coord = coords_dbem, # dbem coordinate system
#              index_code = sau_index_code, # SAU index for eez to grid
#              neighbours = ob_meow, # Headdings must be region and adjacent_region
#              hs_index = ob_index, # First headding should be index, second will be re-named
#              folder_name = "straddling_realm_ob" # folder to save result
# )

# All species lapply
# lapply(run_me,
#        stradd_index,
#        model = "All", # datasets to include (see transboundary work)
#              coord = coords_dbem, # dbem coordinate system
#              index_code = sau_index_code, # SAU index for eez to grid
#              neighbours = ob_meow, # Headdings must be region and adjacent_region
#              hs_index = ob_index, # First headding should be index, second will be re-named
#              folder_name = "straddling_realm_ob" # folder to save result
# )



cl <- makeCluster(10) # total 12
# registerDoSNOW(cl)

repetitions <- length(run_me)
pb <- txtProgressBar(max = repetitions, style = 3)

progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)


foreach(i=1:repetitions,
        .combine = rbind,
        .packages = "tidyverse",
        .options.snow = opts,
        .verbose = T) %dopar% 
  stradd_index(
    run_me[i],
    model = "All",
    coord = coords_dbem,
    index_code = sau_index_code, # SAU index for eez to grid
    neighbours = ob_meow, # Headdings must be region and neighbouring_region
    hs_index = ob_index, # First headding should be index, second will be re-named
    folder_name = "straddling_realm_ob" # folder to save result
  )

close(pb)
stopCluster(cl)
gc()

```

## Estimating Proportion change

### Control pannel for RFMO to realm

```{r get_straddling, eval = F}

# Get fao areas on DBEM grid
# fao_area_grid <- my_path("Spa", "DBEM","fao_to_dbem_grid.csv", read = T) 
meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T) %>% 
  clean_names() %>% 
  select(index,realm)

# meow_dbem_grid %>% left_join(coords_dbem) %>% 
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = realm
#     )
#   )


# RFMO data (REQUIRED)
rfmo_index <- my_path("Spa","/SAU/SAU_RFMO/","RFMO_Index_Code.csv", read = T)


# Spp list
spp_complete <- list.files(my_path("R","Straddling_realm_rfmo/"))
straddling_spp <- str_replace(spp_complete,"\\_.*","")

# Species to ran
ran_species <- list.files(my_path("R","Per_change_realm_rfmo"))
ran_species <- str_sub(ran_species,1,6)

# Run reminindg species
run_me_list <- straddling_spp[!(straddling_spp %in% ran_species)]


run_me_list <- highly_migratory_spp %>% 
  filter(taxon_key %in% straddling_spp) %>% 
  pull(taxon_key)



# stradd_data <- bind_rows(
#   lapply(straddling_spp,GetResults)
# ) %>% 
#   mutate(taxon_key = as.character(taxon_key))


# For Lauren
# dbem_index <- my_data("sau_index") %>% 
#   left_join(meow_dbem_grid) %>% 
#   group_by(eez_name,realm) %>% 
#   tally() %>% 
#   filter(!is.na(realm))

# write.csv(dbem_index, "eez_to_realm.csv")

```

#### Proportion estimate

```{r proportion_call, eval = F}

# Single species
# taxon_proportion(taxon_key = 600069,
#                  dbem_grid = meow_dbem_grid,
#                  hs_index = ob_index,
#                  folder_name = "per_change_realm_ob"
# )

# Multiple speices in one
# suppressMessages(
#   lapply(straddling_spp[1:2],
#          taxon_proportion)
# )

#Multiple species in parallel
suppressMessages(
  mclapply(run_me_list,
           taxon_proportion,
           dbem_grid = meow_dbem_grid,
           hs_index = rfmo_index,
           high_mig = T,
           folder_name = "per_change_realm_rfmo",
           mc.cores = detectCores()-2)
)


```


### Control pannel for Ocean Basin to realm

```{r get_straddling, eval = F}

# Get fao areas on DBEM grid
# fao_area_grid <- my_path("Spa", "DBEM","fao_to_dbem_grid.csv", read = T) 
meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T) %>% 
  clean_names() %>% 
  select(index,realm)

# Spp list

# Straddling and highseas data 
non_high_mig <- read_csv("results/supplements/straddling_species.csv") %>% 
  filter(reporting != "UNCLOS") %>% 
  left_join(my_data("dbem_species")) %>% 
  pull(taxon_key)


# stradd_data <- bind_rows(
#   lapply(straddling_spp,GetResults)
# ) %>% 
#   mutate(taxon_key = as.character(taxon_key))


# For Lauren
# dbem_index <- my_data("sau_index") %>% 
#   left_join(meow_dbem_grid) %>% 
#   group_by(eez_name,realm) %>% 
#   tally() %>% 
#   filter(!is.na(realm))

# write.csv(dbem_index, "eez_to_realm.csv")

```

#### Proportion estimate

```{r proportion_call, eval = F}

# Single species
# taxon_proportion(taxon_key = 600069,
#                  dbem_grid = meow_dbem_grid,
#                  hs_index = ob_index,
#                  high_mig = F,
#                  folder_name = "per_change_realm_ob"
)

# Multiple speices in one
# suppressMessages(
#   lapply(run_me_list,
#          taxon_proportion,
#          dbem_grid = meow_dbem_grid,
#          hs_index = ob_index,
#          high_mig = F,
#          folder_name = "per_change_realm_ob"
#   )
# )

#Multiple species in parallel
suppressMessages(
  mclapply(run_me_list,
           taxon_proportion,
           dbem_grid = meow_dbem_grid,
           hs_index = ob_index,
           high_mig = F,
           folder_name = "per_change_realm_ob",
           mc.cores = detectCores()-2)
)


```

### Control pannel for RFMO to RFMO

```{r get_straddling, eval = F}


coords_dbem <- my_data("dbem_coords")

# RFMO on DBEM grid (meow_dbem_grid)
rfmo_grid <- my_path("Spa",extra_path = "SAU/SAU_RFMO", name = "RFMO_Neighbours_List.csv", read = T) %>% 
  filter(territory %in% c("ICCAT","WCPFC","IOTC","IATTC","CCSBT"),
         neighbour%in% c("ICCAT","WCPFC","IOTC","IATTC","CCSBT")) %>% 
  clean_names() 

# RFMO neighbours
rfmo_neighbour <- rfmo_grid %>% 
  group_by(territory,neighbour) %>% 
  tally() %>% 
  select(-n)

# RFMO index
rfmo_index <- my_path("Spa","/SAU/SAU_RFMO/","RFMO_Index_Code.csv", read = T)


# rfmo_index %>% left_join(coords_dbem) %>%
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = rfmo_name
#     )
#   )


# Spp list
spp_complete <- list.files(my_path("R","Straddling_realm_rfmo/"))
straddling_spp <- str_replace(spp_complete,"\\_.*","")

stradd_data <- bind_rows(
  lapply(straddling_spp,GetResults)
) %>% 
  mutate(taxon_key = as.character(taxon_key),
         approach = "rfmo")

# Ocean Biome data
# Spp list
spp_complete <- list.files(my_path("R","Straddling_realm_ob/"))
straddling_spp <- str_replace(spp_complete,"\\_.*","")

stradd_data_ob <- bind_rows(
  lapply(straddling_spp,GetResults, type = "ob")
) %>% 
  mutate(taxon_key = as.character(taxon_key),
         approach = "ocean_basin")


# For Lauren
# dbem_index <- my_data("sau_index") %>% 
#   left_join(meow_dbem_grid) %>% 
#   group_by(eez_name,realm) %>% 
#   tally() %>% 
#   filter(!is.na(realm))

# write.csv(dbem_index, "eez_to_realm.csv")

```


#### Proportion estimate

```{r proportion_call, eval = F}

# taxon_proportion(taxon_key = 600069)

# suppressMessages(
#   lapply(straddling_spp[1:2],
#          taxon_proportion)
# )

# Parallelization


suppressMessages(
  mclapply(straddling_spp,
           rfmo_taxon_proportion,
           mc.cores = detectCores()-2)
)

```

# Results

## Data needed

### Data for highly migratory speices

List of Highly migratory speices according to Annex I Highly migratory species of UNCLOS. Note that we only included those at the species level https://www.un.org/depts/los/convention_agreements/texts/unclos/annex1.htm

```{r un_highly_mig_spp, eval = F}

# List of SAU speciess
exploited_spp <- my_path("G","Species", "exploited_species_list.csv", read = T)


highly_migratory_spp <- tibble(taxon_name = c("Thunnus alalunga","Thunnus thynnus","Thunnus obesus", "Katsuwonus pelamis", "Thunnus albacares", "Thunnus atlanticus","Euthynnus alletteratus","Euthynnus affinis", "Thunnus maccoyii",
                                              "Auxis thazard", "Auxis rochei", 
                                              "Tetrapturus angustirostris", "Tetrapturus belone", "Tetrapturus pfluegeri", "Tetrapturus albidus", "Tetrapturus audax", "Tetrapturus georgei", "Makaira mazara", "Makaira indica","Makaira nigricans",
                                              
                                              "Istiophorus platypterus","Istiophorus albicans",
                                              "Xiphias gladius",
                                              "Coryphaena hippurus",
                                              "Scomberesox saurus","Cololabis saira","Cololabis adocetus","Scomberesox saurus scombroides",
                                              "Hexanchus griseus", "Cetorhinus maximus", "Rhincodon typus"),
                               reffered_as = c(
                                 rep("Tuna",9),
                                 "Frigate mackerel","Frigate mackerel",
                                 rep("Marlin",9),
                                 "Sail-fish","Sail-fish",
                                 "Sword-fish",
                                 "Common dolphinfish",
                                 rep("Saury",4),
                                 rep("Shark",3)
                               )) %>% 
  mutate(shared = "high_migra") %>% 
  left_join(exploited_spp) %>% 
  filter(!is.na(taxon_key))

```

### Create SAU data for fishing groups

```{r}

# rfmo_list <- c(my_path("D","SAU/catch/ccsbt","SAU RFMO 3 v50-1.csv", read = F),
#   my_path("D","SAU/catch/iattc", "SAU RFMO 5 v50-1.csv", read = F),
#   # my_path("D","SAU/catch/iccat",),
#   my_path("D","SAU/catch/iotc","SAU RFMO 7 v50-1.csv", read = F),
#   my_path("D","SAU/catch/wcpfc","SAU RFMO 18 v50-1.csv")
# )

# suppressMessages(
# rfmo_catch <- bind_rows(
#   lapply(rfmo_list, read_csv)) %>%
#   filter(scientific_name %in% unique(prop_data$taxon_name)) %>%
#   group_by(area_name,year,scientific_name,common_name,commercial_group,fishing_entity) %>%
#   #adds up gear type, fishing sectors, catch type and reporting
#   summarise_at(.vars = c("tonnes","landed_value"),
#                .funs = sum) %>%
#   # Average last 10 years of data
#   filter(year >= 2007) %>%
#   group_by(area_name,scientific_name, common_name,commercial_group,fishing_entity) %>%
#   summarise_at(.vars = c("tonnes","landed_value"),
#                .funs = mean,
#                na.rm = T) %>%
#   filter(!(common_name == "Indian mackerel" & fishing_entity == "Thailand"),
#          !(common_name == "Japanese anchovy" & fishing_entity %in% c("China","Japan")),
#          !(common_name == "Short mackerel" & fishing_entity == "Indonesia")
#          ) #remove wrong data as per personal communication with Deng P.
# ) %>%
#   mutate(commercial_group = ifelse(is.na(commercial_group),"Other fishes & inverts",commercial_group),
#          commercial_group = ifelse(scientific_name %in% c("Clupea harengus","Regalecus glesne"),"Herring-likes",
#                                    ifelse(scientific_name %in% c("Glyptocephalus cynoglossus","Hippoglossoides platessoides","Hippoglossus hippoglossus"),"Flat-fish",
#                                           commercial_group)
#          )
#   )


sau_groups <- read.csv("./results/supplements/straddling_species.csv")

```

### Spatial data needed

```{r spatial_data, eva = T}

#-----------------# 
## Georeferenced ##
#-----------------# 

# SAU relations between INDEX and Country's EEZs
# sau_index_code <- my_data("sau_index")

#world land 
sf_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>%
  st_transform(crs = 4326) %>% 
  st_transform(crs = "+proj=eck4")

# meows
sf_meow <- my_sf("MEOW") %>% 
  clean_names()
st_crs(sf_meow) = 4326

sf_meow <- sf_meow %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>%  #fixes lines across map
  st_transform(crs = "+proj=eck4")



# RFMO regions
# sf_rfmo <- my_sf("RFMO_tuna",simple = 1) %>% 
# st_transform(crs = "+proj=eck4")

# SAU shapefile
# sf_eez <- my_sf("SAU", simple = 0.1)

# SAU index table
sau_index_code <- my_data("sau_index")


basin_data <- my_path("Spa","gabs","ALL_META_HAB_CMIP6_LAYERS.csv", read = T) %>% 
  mutate(
    basin = ifelse(basin2 == 0, "w_atlantic",
                   ifelse(basin2 == 1 ,"e_atlantic",
                          ifelse(basin2 == 2, "e_pacific",
                                 ifelse(basin2 == 3, "w_pacific",
                                        ifelse(basin2 == 4, "w_indian",
                                               ifelse(basin2 == 5,"e_indian",
                                                      ifelse(basin2 == 6,"antarctic",
                                                             ifelse(basin2 == 7,"actic",
                                                                    NA))))))))
  ) %>% 
  dplyr::select(lon = longitude,
                lat = latitude,
                basin) %>% 
  left_join(my_data("dbem_coords")) %>% 
  filter(!is.na(basin))
```

## Highly migratory species

```{r}

spp_complete <- list.files(my_path("R","Per_change_realm_rfmo/"))
straddling_spp <- str_replace(spp_complete,"\\_.*","")

straddling_hm <- bind_rows(
  lapply(straddling_spp,GetResults, type = "strad")
) %>% 
  rename(realm_name = realm,
         hs_name = rfmo_name,
         area_hs = area_rfmo
  ) %>% 
  mutate(approach = "rfmo",
         category = "highly migratory") %>% 
  filter(taxon_key %in% highly_migratory_spp$taxon_key) # filter out only UNCLO's species

length(unique(straddling_hm$taxon_key))# 19 species modeleed that are highly migratory

# Get Highly migratory straddling stocks
prop_data_esm_hm <- bind_rows(
  lapply(unique(straddling_hm$taxon_key),GetResults, type = "prop")
) %>% 
  select(-area_hs) %>% 
  # rename(hs_name) %>% 
  # View()
  # Include area index info
  left_join(straddling_hm,
            by = c("taxon_key","hs_name","realm_name")
  ) %>% 
  filter(area_hs > 10,
         area_hs < 90) %>% 
  # Remove stocks not present in high seas
  filter(
    low_tresh != 0 &
      mean != 0 &
      top_tresh != 0,
    low_tresh != 100 &
      mean != 100 &
      top_tresh != 100
  ) %>%
  left_join(exploited_spp) 

length(unique(prop_data_esm_hm$taxon_key)) # species 


prop_data_hm <- prop_data_esm_hm %>%
  # Re- estimate change with average of all ESMs
  group_by(taxon_key,taxon_name,common_name,rcp,period,hs_name,realm_name,approach) %>% 
  summarise_at(
    .vars = c("hs_hist_prop","low_tresh","mean","top_tresh"),
    .funs = mean,
    na.rm = T) %>% 
  mutate(
    change = ifelse(mean > top_tresh,"gain",
                    ifelse(mean < low_tresh,"lost","same")
    ),
    category = "highly migratory"
  )

length(unique(prop_data_hm$taxon_key))# 15 numbers after filters

```

## Non-highly migratory species

```{r}

spp_complete <- list.files(my_path("R","Per_change_realm_ob/"))
straddling_spp <- str_replace(spp_complete,"\\_.*","")


straddling_nhm <- bind_rows(
  lapply(straddling_spp,GetResults, type = "ob")
) %>% 
  mutate(approach = "ocean_basin",
         category = "straddling") %>% 
  rename(realm_name = realm) %>% 
  filter(!taxon_key %in% highly_migratory_spp$taxon_key)

length(unique(straddling_nhm$taxon_key))# 131

# Get straddling stocks after applying filters
prop_data_esm_nhm <- bind_rows(
  lapply(unique(straddling_nhm$taxon_key),GetResults, type = "prop_ob")
) %>% 
  filter(
    taxon_key %in% straddling_nhm$taxon_key,
    area_hs >= 10,
    area_hs <= 90) %>% 
  # Remove species not present in high seas
  filter(
    low_tresh != 0 &
      mean != 0 &
      top_tresh != 0,
    low_tresh != 100 &
      mean != 100 &
      top_tresh != 100
  ) %>% 
  left_join(exploited_spp)  %>% 
  mutate(approach = "ocean_basin",
         category = "straddling")

length(unique(prop_data_esm_nhm$taxon_key)) # 52 number that were identified (52/131) 40%


prop_data_nhm <- prop_data_esm_nhm %>%
  # Re- estimate change with average of all ESMs
  group_by(taxon_key,taxon_name,common_name,rcp,period,hs_name,realm_name,approach,category) %>% 
  summarise_at(
    .vars = c("hs_hist_prop","low_tresh","mean","top_tresh"),
    .funs = mean,
    na.rm = T) %>% 
  mutate(change = ifelse(mean > top_tresh,"gain",
                         ifelse(mean < low_tresh,"lost","same")
  )
  )

length(unique(prop_data_nhm$taxon_key)) # 52 number that changed (52/131) 40%


#### Combine both data ###
prop_data_esm <- bind_rows(
  prop_data_esm_hm,
  prop_data_esm_nhm
)

prop_data <- bind_rows(
  prop_data_hm,
  prop_data_nhm
)

length(unique(prop_data$taxon_key)) # 67 species total (15 highly migratory + 52 non-highly migratory)


```

## Highly migratory species between RFMOs

```{r}

list_rfmo_spp <- str_sub(list.files(my_path("R","Per_change_rfmo_rfmo/")),1,6)

rfmo_prop_data_esm <- bind_rows(
  lapply(list_rfmo_spp,GetResults, type = "rfmo")
) %>% 
  # Remove species not present in high seas
  filter(
    taxon_key %in% highly_migratory_spp$taxon_key,
    low_tresh_t != 0 &
      mean_t != 0 &
      top_tresh_t != 0,
    low_tresh_n != 1 &
      mean_t != 1 &
      top_tresh_n != 1
  ) %>% 
  left_join(exploited_spp)

# Re-estimate change with average of all ESMs
rfmo_prop_data <- rfmo_prop_data_esm %>%  
  group_by(taxon_key,taxon_name,common_name,rcp,period,rfmo_t,rfmo_n) %>% 
  summarise_at(
    .vars = c("low_tresh_t","mean_t","top_tresh_t"), # Using just the territory RFMO
    .funs = mean,
    na.rm = T) 

# Remove duplicates (it is a bi-lateral change)
length(unique(rfmo_prop_data$taxon_key)) # 13 species 

```

## Save data for Borealis

### Highly and non-highly migratory

```{r}

###  Save data for Borealis
write_csv(prop_data,
          my_path("R", "borealis", name = "proportion_change_data_v2.csv")
)

# Metadata 
data.frame(
  "column_name" = names(prop_data),
  "description" = 
    c(
      "Unique taxon id",
      "Taxon scientific name according to the Sea Around Us",
      "Taxon common name (eng.)",
      "Climate change scenario. rcp85 = ssp5-8.5; rcp26 = ssp1-2.6",
      "Time period of analysis. Ear = early (2030); mid = middle (2050)",
      "Name of high seas region",
      "Name of realm",
      "Estimation approach. If highly migratory tuna, RFMO, else ocean basin",
      "historic proportion of stock share ration in the high seas",
      "lower threshold of historical stock share ratio proportion given by the mean - 2*sd",
      "future mean threshold of stock share ratio proportion",
      "upper threshold of historical stock share ratio proportion given by the mean + 2*sd",
      "Identification of shift in terms of hs_name. The mean needs to overshoot the thresholds for a stock to shift.",
      "Type of straddling stock according to the definition. straddling and straddling highly migratory."
    )
) %>% 
  write_csv(.,
            my_path("R", "borealis", name = "proportion_change_metadata.csv")
  )
```

### Highly migratory between RFMOs

```{r}

# Save data for Borealis
write_csv(rfmo_prop_data,
          my_path("R", "borealis", name = "hm_rfmo_proportion_change_data_v2.csv")
)

# Metadata 
data.frame(
  "column" = names(rfmo_prop_data),
  "description" = 
    c(
      "Unique taxon id",
      "Taxon scientific name according to the Sea Around Us",
      "Taxon common name (eng.)",
      "Climate change scenario. rcp85 = ssp5-8.5; rcp26 = ssp1-2.6",
      "Time period of analysis. Ear = early (2030); mid = middle (2050)",
      "RFMO territory. RFMO t wins/looses proporiton referent to RFMO n",
      "RFMO neighbour",
      "lower threshold of historical proportion given by the mean - 2*sd",
      "mean threshold of future proportion",
      "upper threshold of historical proportion given by the mean + 2*sd"
      
    )
) %>% 
  write_csv(.,
            my_path("R", "uploaded", name = "hm_proportion_change_metadata.csv")
  )
```


## Straddling identification

### FIG. 1A- Straddling species map

```{r straddling_map, eval = T, echo = F}

# Relationship table for RFMO to ocean basin
rfmo_to_ob <- data_frame(
  hs_name = c("ICCAT","ICCAT","WCPFC","IATTC","IOTC","CCSBT","CCSBT","CCSBT","CCSBT","CCSBT","CCSBT","CCSBT"),
  basin = c("w_atlantic","e_atlantic","w_pacific","e_pacific","e_indian","w_indian","w_atlantic","e_atlantic","w_pacific","e_pacific","e_indian","w_indian")
)


# Get MEOW and EEZs (REMOVE)
prop_data_map <- prop_data %>% 
  left_join(rfmo_to_ob) %>%
  mutate(
    basin = ifelse(is.na(basin),hs_name,basin)
  )

# Number of straddling stocks by MEOW
strad_meow <- prop_data_map %>% 
  group_by(realm_name) %>% 
  summarise(n = length(unique(taxon_key)))

# Map it
sf_meow_map <- sf_meow %>% 
  group_by(realm_name = realm,rlm_code) %>% 
  tally() %>% 
  select(-n)

strad_meow_map <- sf_meow_map %>% 
  left_join(strad_meow) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  st_transform(crs = "+proj=eck4")

# Number of straddling stocks by High seas
stradd_hs <- prop_data_map %>% 
  group_by(basin) %>%
  summarise(n = length(unique(taxon_key)))

# Number of straddling stocks by high seas and Realm
rfmo_realm <- prop_data_map %>% 
  group_by(basin,realm_name) %>% 
  summarise(n = length(unique(taxon_key)))

# Transform projection of all
basin_sf <- basin_data %>% 
  left_join(stradd_hs) %>% 
  st_as_sf(.,
           coords = c("lon", "lat"), crs = 4326) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  st_transform(crs = "+proj=eck4")

map_high_seas_stradd <-
  ggplot() + 
  geom_sf(data = basin_sf,
          aes(color = n)) +
  geom_sf(data = strad_meow_map,
          aes(fill = n)) +
  geom_sf(data = sf_land, aes(), fill = "antiquewhite", color = "grey50") +
  scale_fill_viridis_c("Number of Straddling Stocks", na.value = "white",
                       limits = c(0,50)) +
  scale_color_viridis_c("Number of Straddling Stocks", na.value = "white",
                        limits = c(0,50)) +
  my_ggtheme_m(leg_pos = "bottom",
               leg_width = 2) +
  theme(legend.text = element_text(size = 14),
        legend.title = element_text(size = 16))

# Save plot 
ggsave("./results/figures/fig_1a.png",
       map_high_seas_stradd,
       height = 7,
       width = 12
)

```

### FIG. 1B- Straddling species bar plot

```{r fig_1c_high_seas_only}

stradd_commercial_df <- prop_data %>% 
  left_join(exploited_spp) %>% 
  left_join(sau_groups) %>%
  mutate(hs_name = "high seas") %>%
  group_by(hs_name,realm_name,commercial_group) %>% 
  summarise(n = length(unique(taxon_key)),
            species = paste(unique(common_name), collapse = ";")) %>% 
  mutate(realm_or = realm_name) %>% 
  filter(n >0,
         !is.na(commercial_group)) %>% 
  mutate(
    realm_name = str_replace(realm_name," ", "\n"),
    realm_name = str_replace(realm_name,"Southern","S."),
    realm_name = str_replace(realm_name,"South","S."),
    realm_name = str_replace(realm_name,"Northern","N."),
    realm_name = str_replace(realm_name, "Western", "W."),
    realm_name = str_replace(realm_name,"Eastern", "E.")
  )

# Color scale
commercial_scale <- c(
  "Cod-likes" =  wes_palette("Royal2",n = 5)[3],
  "Flatfishes" = wes_palette("IsleofDogs1",n = 5)[1],
  "Herring-likes" = wes_palette("IsleofDogs2",n = 5)[3],
  "Other fishes & inverts" = "grey",
  "Perch-likes" = wes_palette("Darjeeling1",n = 5)[4],
  "Salmon, smelts, etc" = wes_palette("GrandBudapest1",n = 4)[3],
  "Scorpionfishes" = wes_palette("Darjeeling2",n = 5)[1],
  "Sharks & rays" = wes_palette("GrandBudapest1",n = 4)[2],
  "Small pelagic" = wes_palette("Darjeeling2",n =5)[3],
  "Squids" = wes_palette("Darjeeling2",n =5)[4],
  "Tuna & billfishes" = wes_palette("Darjeeling2",n =5)[5]
)


plot <-
  stradd_commercial_df %>%
  group_by(hs_name,realm_name,realm_or,commercial_group) %>% 
  summarise(n = sum(n,na.rm = T)) %>% 
  # View()
  ggplot() +
  geom_bar(
    aes(
      x = tidytext::reorder_within(commercial_group,n,realm_or),
      y = round(n),
      fill = commercial_group
    ),
    stat = "identity"
  ) +
  facet_wrap(~realm_or, 
             # switch = "x",
             scales = "free",
             ncol = 4
  ) +
  labs(x = "", y = "") +
  scale_fill_manual("Commerical group",values = commercial_scale) +  # Map colors based on commercial_scale
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_blank(),
    legend.position = "bottom",
    legend.text = element_text(size = 8.5),
    strip.text.x = element_text(size = 8.5),
    # strip.text.y = element_text(size = 20, angle = 90),
    axis.text.y = element_text(size = 7),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

plot_name <- paste0("./results/figures/fig1_b.png")

ggsave(plot_name,
       plot,
       height = 4,
       width = 8
)

```

### Paper numbers on top shared species

```{r}

prop_data %>% 
  left_join(sau_groups) %>% 
  mutate(combo = paste0(realm_name,"_",hs_name)) %>% 
  group_by(taxon_name,common_name,commercial_group) %>% 
  summarise(value = length(unique(combo))) %>%
  left_join(highly_migratory_spp) %>% 
  # View()
  top_n(5,value) %>% 
  arrange(desc(value)) %>% 
  View()

```

## Proportion change

### Proportion change table

```{r}
# Total changes

reg_total <- prop_data_esm %>% 
  mutate(change = ifelse(mean > top_tresh,"gain",
                         ifelse(mean < low_tresh,"lost","same")
  )
  ) %>% 
  group_by(period,rcp,hs_name,change,realm_name,esm) %>% 
  tally() %>% 
  group_by(rcp,period,esm) %>%
  summarise(total_changes = sum(n))

prop_data_esm %>% 
  mutate(change = ifelse(mean > top_tresh,"gain",
                         ifelse(mean < low_tresh,"lost","same")
  )
  ) %>%
  group_by(period,rcp,hs_name,change,realm_name,esm) %>% 
  tally() %>% 
  group_by(rcp,period,esm,change) %>%
  summarise(n = sum(n,na.rm =T)) %>% 
  left_join(reg_total) %>%
  mutate(per = round(n/total_changes*100)) %>%
  group_by(rcp,period,change) %>%
  summarise_if(is.numeric, c("m" = mean,
                             "sd" = sd,
                             "max" = max,
                             "min" = min),
               na.rm = T
  ) %>% 
  mutate_if(is.numeric,round) %>% 
  select(1:3,n_min,n_m,n_max,n_sd,per_min,per_m,per_max,n_sd) %>%
  View()
  # write_csv("./results/tables/gains_losses.csv")

```

### FIG 2. Shifts by commercial group

```{r}

commerica_group_total <- prop_data %>% 
  left_join(sau_groups) %>% 
  group_by(period,rcp,commercial_group) %>% 
  summarise(tot = n())

prop_data %>% 
  left_join(sau_groups) %>% 
  # View()
  group_by(period,rcp,change,commercial_group) %>% 
  tally() %>%
  left_join(commerica_group_total) %>% 
  # View()
  # Fix labels
  mutate(
    per = n/tot*100,
    change = ifelse(change == "gain","High Seas",
                    ifelse(change == "lost","EEZ","Same")),
    period = ifelse(period == "ear","Early","Middle"),
    rcp = ifelse(rcp == "rcp26","SSP1-2.6 (Low emission scenario)","SSP5-8.5 (High emission scenario)")#,
  ) %>% 
  # filter(change != "Same") %>%
  # View()
  ggplot() +
  geom_bar(
    aes(
      x = reorder(commercial_group,n),
      y = per,
      fill = change
    ),
    stat = "identity"
  ) +
  facet_grid(period~rcp) +
  scale_fill_viridis_d("Direction of Change",
                       direction = -1) +
  scale_x_discrete("Commercial group") +
  scale_y_continuous("Percentage of stocks (%)") + 
  my_ggtheme_p(
    leg_pos = "right",
    ax_tl_s = 16,
    ax_tx_s = 12
    
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) 

ggsave(filename = "./results/figures/straddling_status_barplot.png",
       plot = last_plot(),
       height = 7,
       width = 10)

```

### FIG 3. Circle diagram

Resources:
- https://r-charts.com/flow/chord-diagram/
- https://www.data-to-viz.com/graph/chord.html


```{r circle_diagrams, eval = T, echo = T}

total_prop_data <- prop_data %>% 
  group_by(period,rcp,realm_name) %>% 
  tally() %>% 
  rename(total = n)

circle_df <- prop_data %>% 
  mutate(hs_name = "High Seas") %>%
  # filter(realm_name == "Central Indo-Pacific")
  group_by(period,rcp,hs_name,change,realm_name) %>% 
  tally() %>% 
  left_join(total_prop_data) %>% 
  mutate(
    n_per = round((n/total)*100)
  ) %>% 
  # select(-total) %>% 
  # filter(rcp == "rcp85") %>% 
  mutate(
    realm_name = str_replace(realm_name,"Southern","S."),
    realm_name = str_replace(realm_name,"South","S."),
    realm_name = str_replace(realm_name,"Northern","N."),
    realm_name = str_replace(realm_name, "Western", "W."),
    realm_name = str_replace(realm_name,"Eastern", "E."),
    realm_name = str_replace(realm_name,"Temperate", "T."),
    realm_name = str_replace(realm_name,"Tropical", "Tr."),
    realm_name = str_replace(realm_name,"Central", "C."),
    name = realm_name
    # name = str_replace(realm_name," ", "\n")
  )

# Color pallet
mycolor_scale <- 
  c(
    "High Seas" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[1],
    "C. Indo-Pacific" =  wes_palette("Darjeeling2",n = 5)[2],
    "T. Australasia" = wes_palette("Moonrise3",n = 5)[2],
    "T. S. America" = wes_palette("Moonrise3",n = 5)[3],
    "S. Ocean" = wes_palette("Darjeeling2",n = 5)[3],
    "W. Indo-Pacific" = wes_palette("Moonrise3",n = 5)[4],
    "E. Indo-Pacific" = wes_palette("Moonrise3",n = 5)[5],
    "Tr. E. Pacific" = wes_palette("Cavalcanti1",n = 5)[2],
    "Arctic" = wes_palette("FantasticFox1",n = 5)[2],
    "T. N. Atlantic" = wes_palette("FantasticFox1",n =5)[3],
    "T. S. Africa" = wes_palette("FantasticFox1",n =5)[4],
    "Tr. Atlantic" =   wes_palette("FantasticFox1",n =5)[5],
    "T. N. Pacific" = wes_palette("Darjeeling2", n = 5)[5]
  )

# Run plots

# Define the values for rcp, period_val, and change_val
rcp_vals <- c("rcp26", "rcp85")
period_vals <- c("ear", "mid")
change_vals <- c("gain", "lost", "same", "net")

# Use nested lapply to iterate over the combinations
lapply(rcp_vals, function(rcp) {
  lapply(period_vals, function(period) {
    lapply(change_vals, function(change) {
      circular_plot(data = circle_df, period_val = period, change_val = change, rcp = rcp)
    })
  })
})

```

##### Figure Key for regions v.s. high seas

```{r}

# Random data for legend
set.seed(999)
mat = matrix(c(5,  6, 4,  10,  7, 7,  0, 20, 7,  5,  3,  9), 2, 6) 
# rownames(mat) = paste0("S", 1:3)
rownames(mat) = c("High Seas", "High Seas")
colnames(mat) = c("Region F","Region E","Region D","Region C","Region B","Region A")


grid.col = c("High Seas" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[1],
             "Region A" = "grey", "Region B" = "grey", "Region C" = "orange", "Region D" = "grey", "Region E" = "grey", "Region F" = "grey")

png("./results/figures/circle/legenda.png",
    width = 700, height = 700, res = 150, units = "px")
chordDiagram(t(mat), 
             grid.col = grid.col,
             direction.type = "arrows",
             link.arr.type = "big.arrow",
             link.arr.length = 0.1,
             directional =1,
             annotationTrack = "grid", 
             preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(t(mat))))))
)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] - .1, 
              labels = sector.name[!sector.name %in% c("High Seas")], 
              facing = "clockwise", 
              cex = 0.8,
              niceFacing = TRUE, #Orientation of label 
              adj = c(1, 0.5) # adjust position of label (0.5 middle)
  )
  circos.axis(h = "top", 
              # labels.font	= "Times",
              labels.cex = 0.5, 
              major.tick.length = 1, 
              sector.index = sector.name,
              track.index = 2)
}, bg.border = NA)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] - .1, 
              labels = sector.name[sector.name %in% c("High Seas")], 
              facing = "bending.outside", 
              cex = 0.8, 
              niceFacing = TRUE, #Orientation of label 
              adj = c(0.5, 4) # adjust position of label (0.5 middle)
  )
}, bg.border = NA)


dev.off()
```

### FIG 4. Intensity of change

```{r}

intense_data <- prop_data %>% 
  # mutate(hs_name = "High Seas") %>%
  filter(
    # period == "ear",
    # rcp == "rcp26",
    # taxon_key == 600006,
    # change != "same"
    change != "same"
  ) %>% 
  # Estimte intensity
  mutate(
    eez_hist_prop = 100-hs_hist_prop,
    mean_eez = 100-mean,
    per_change_hs = my_chng(hs_hist_prop,mean,100),
    per_change_eez = my_chng(eez_hist_prop,mean_eez,100)
  ) %>% 
  # mutate_if(is.numeric,round) %>% 
  # View()
  left_join(sau_groups) %>% 
  # View()
  group_by(commercial_group,period,rcp,hs_name,realm_name) %>%
  summarise(
    mean_intensity = mean(per_change_eez,na.rm = T)
  ) %>% 
  filter(mean_intensity != 0) %>%
  # View()
  group_by(commercial_group,period,rcp,realm_name) %>%
  summarise(
    sd_intensity = sd(mean_intensity,na.rm = T),
    mean_intensity = mean(mean_intensity,na.rm = T)
  ) %>% 
  filter(mean_intensity != 0)


# Plot figure
intense_data %>% 
  filter(period == "ear") %>%
  mutate(
    ssp = ifelse(rcp == "rcp26","SSP1-2.6\n(Low emission scenario)","SSP5-8.5\n(High emission scenario)"),
    Direction = ifelse(mean_intensity < 0,"High seas","EEZs"),
    # reorder_y = tidytext::reorder_within(commercial_group,mean_intensity,realm_name),
    commercial_group = str_replace(commercial_group," ", "\n"),
    realm_name = str_replace(realm_name,"Southern","S."),
    realm_name = str_replace(realm_name,"South","S."),
    realm_name = str_replace(realm_name,"Northern","N."),
    realm_name = str_replace(realm_name, "Western", "W."),
    realm_name = str_replace(realm_name,"Eastern", "E."),
    realm_name = str_replace(realm_name,"Temperate", "T."),
    realm_name = str_replace(realm_name,"Tropical", "Tr."),
    realm_name = str_replace(realm_name,"Central", "C."),
    name = str_replace(realm_name," ", "\n"),
    reorder_y = tidytext::reorder_within(realm_name,mean_intensity,commercial_group)
  ) %>% 
  # View()
  ggplot() +
  geom_bar(
    aes(
      # x = commercial_group,
      # x = reorder(commercial_group,mean_intensity),
      x = reorder_y,
      y = mean_intensity,
      color = Direction,
      fill = Direction
    ),
    stat = "identity",
    # position = position_dodge2()
  ) +
  geom_errorbar(
    aes(
      x = reorder_y,
      ymin = mean_intensity - sd_intensity,
      ymax = mean_intensity + sd_intensity
    ),
    width = 0.25
  ) +
  coord_flip() +
  scale_color_viridis_d(direction = -1,begin = .5) +
  scale_fill_viridis_d(direction = -1, begin = .5) +
  facet_grid(commercial_group~ssp,scales = "free_y",space = "free_y") +
  scale_x_reordered("Region")  +
  my_ggtheme_p(leg_pos = "right",
               ax_tl_s = 12,
               ax_tx_s = 10,
               leg_tl_s = 12,
               leg_tx_s = 10,
               facet_tx_s = 12
  ) +
  ylab("Change in SSR within EEZs relative to historic period (%)") +
  theme(text = element_text(family = "Times New Roman"),
        strip.text.y = element_text(angle = 1)
  )

ggsave(
  "./results/figures/per_chng/per_chng_ear.png",
  last_plot(),
  width = 7,
  height = 8)

```


## RFMO to RFMO

```{r}

sankey_rfmo <- rfmo_prop_data %>% 
  mutate(change = ifelse(mean_t > top_tresh_t,"gain",
                         ifelse(mean_t < low_tresh_t,"lost","same")
  )
  ) %>% 
  group_by(period,rcp,rfmo_name = rfmo_t,rfmo_n,change) %>% 
  tally() %>% 
  rename(
    name = rfmo_n,
    hs_name = rfmo_name
  ) %>% 
  mutate(n_per = NA)

mycolor_scale <- 
  c(
    "CCSBT" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[1],
    "IATTC" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[2],
    "ICCAT" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[3],
    "IOTC" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[4],
    "WCPFC" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[5]
  )


rcp_vals <- c("rcp26", "rcp85")
period_vals <- c("ear", "mid")
change_vals <- c("gain", "lost", "same", "net")
level_val <- "rfmo"  # Assuming this value remains constant

# Use nested lapply to iterate over the combinations
lapply(rcp_vals, function(rcp) {
  lapply(period_vals, function(period) {
    lapply(change_vals, function(change) {
      circular_plot(data = sankey_rfmo, period_val = period, change_val = change, level = level_val, rcp = rcp)
    })
  })
})


circular_plot(data = sankey_rfmo, period_val = "mid", change_val = "net", level = "rfmo", rcp = "rcp85")

```

### RFMO map for figure

```{r}
sf_rfmo_map <-
  sf_rfmo %>% 
  ggplot() +
  geom_sf(aes(fill = rfmo_name),
          alpha = 0.5) +
  scale_fill_manual(values = mycolor_scale) +
  my_land_map() +
  # Add RFMO labels
  geom_label_repel(data = sf_rfmo,
                   aes(label = rfmo_name,
                       geometry = geometry,
                       fill = rfmo_name),
                   stat = "sf_coordinates",
                   direction = "y",
                   seed = 5,
                   max.overlaps = 10,
                   point.padding = 50,
                   hjust = "right",
                   nudge_x = ifelse(sf_rfmo$rfmo_name == "ICCAT",-13,
                                    ifelse(sf_rfmo$rfmo_name == "WCPFC",10,-5)),
                   nudge_y = ifelse(sf_rfmo$rfmo_name == "CCSBT",-20,
                                    ifelse(sf_rfmo$rfmo_name == "ICCAT",10,
                                           ifelse(sf_rfmo$rfmo_name == "WCPFC",10,1))),
                   alpha = 0.6,
                   size = 4
  ) +
  my_ggtheme_m(leg_pos = "")


ggsave(
  "./results/figures/rfmo_map.png",
  sf_rfmo_map,
  width = 10,
  height = 5
)

```


### Figure Key for RFMOs

```{r}
# Example data (connections between categories)
grid.col = c(
  "RFMO A" = viridis(8, alpha = 1, begin = 0, end = 1, option = "D")[1],
  " " = "grey",
  "RFMO B" = "grey",
  "RFMO C" = "grey"
)


mat3 = matrix(rnorm(15), 3)
colnames(mat3) = c("RFMO B","RFMO C"," ","RFMO A"," ")
cor_mat = cor(mat3)


png("./results/figures/circle/rfmo_legend.png",
    width = 700, height = 700, res = 150, units = "px")
chordDiagram(cor_mat, 
             grid.col = grid.col,
             directional = 1, 
             direction.type = c("diffHeight","arrows"),
             link.arr.type = "big.arrow",
             link.arr.length = 0.1,
             link.sort = T,
             link.largest.ontop = TRUE,
             transparency = 0.30,
             scale = TRUE,
             symmetric = TRUE
)
dev.off()


```

### Numbers for RFMO - RFMO

```{r}

rfmo_prop_data %>% 
  mutate(change = ifelse(mean_t > top_tresh_t,"gain",
                         ifelse(mean_t < low_tresh_t,"lost","same")
  )
  ) %>% 
  group_by(rfmo_t,rfmo_n,period,rcp,change) %>% 
  tally() %>% 
  group_by(period,rcp,change) %>% 
  summarise(sum = sum(n)) %>% 
  View()




reg_total_rfmo <- rfmo_prop_data_esm %>% 
  mutate(change = ifelse(mean_t > top_tresh_t,"gain",
                         ifelse(mean_t < low_tresh_t,"lost","same")
  )
  ) %>% 
  group_by(period,rcp,rfmo_t,change_t,rfmo_n,esm) %>% 
  tally() %>% 
  group_by(rcp,period,esm) %>%
  summarise(total_changes = sum(n))

rfmo_prop_data_esm %>% 
  mutate(change = ifelse(mean_t > top_tresh_t,"gain",
                         ifelse(mean_t < low_tresh_t,"lost","same")
  )
  ) %>% 
  group_by(period,rcp,rfmo_t,change_t,rfmo_n,esm) %>% 
  tally() %>% 
  group_by(rcp,period,esm,change_t) %>%
  summarise(n = sum(n)) %>%
  left_join(reg_total_rfmo) %>%
  mutate(per = round(n/total_changes*100)) %>%
  group_by(rcp,period,change_t) %>%
  summarise_if(is.numeric, c("m" = mean,
                             "sd" = sd)
  ) %>% 
  mutate_if(is.numeric,round) %>% 
  select(1:3,n_m,n_sd,per_m,per_sd) %>% 
  View()


```

# Supplement material

## Straddling treshold 
Supplemental material to show the different ammount of Straddling stocks depending on the threshold 

```{r threshold_sensitivity, eval = F}

bind_rows(
  bind_rows(
    lapply(unique(straddling_nhm$taxon_key),GetResults, type = "prop_ob")
  ) %>% 
    filter(taxon_key %in% straddling_nhm$taxon_key) %>% 
    mutate(
      category = "straddling"
    ),
  bind_rows(
    lapply(unique(straddling_hm$taxon_key),GetResults, type = "prop")
  ) %>% 
    mutate(
      category = "highly migratory"
    )
) %>% 
  filter(
    rcp == "rcp26",
    period == "ear",
    esm == "gfdl"
  ) %>% 
  # View()
  mutate(
    hs_name = ifelse(hs_name == "actic","Arctic_HS",hs_name),
    tresh_30 = ifelse(area_hs > 30, "30%",NA),
    tresh_20 = ifelse(area_hs > 20, "20%",NA),
    tresh_0 = ifelse(area_hs > 0, "0%",NA),
    tresh_10 = ifelse(area_hs > 10, "10%",NA),
    combo = paste(realm_name,hs_name, sep = "-")
  ) %>%
  # View()
  group_by(category,combo,tresh_30,tresh_20,tresh_10,tresh_0) %>%
  tally() %>%
  # View()
  gather("value","thresh_level",tresh_30:tresh_0) %>%
  filter(!is.na(thresh_level)) %>%
  # View()
  group_by(category,combo,thresh_level) %>%
  summarise(n_thresh = sum(n,na.rm = T)) %>%
  # filter(thresh_level !="0%") %>% 
  # filter(combo == "Arctic-ICCAT") %>%
  # View()
  ggplot() +
  geom_bar(
    aes(
      # x = reorder(combo,desc(combo)),
      x = reorder(combo,desc(n_thresh)),
      y = n_thresh,
      fill = thresh_level
    ),
    stat = "identity",
    position = "dodge"
  ) +
  labs(
    x = "Region and high seas combination",
    y = "Number of stocks"
  ) +
  coord_flip() +
  # facet_wrap(~ realm_name) +
  scale_fill_manual("Threshold level", values = wes_palette("Royal1")) +
  scale_y_continuous(expand = c(0, 0),
                     breaks = seq(0,25,5),
                     limits = c(0,25)
  ) +
  my_ggtheme_p(
    leg_pos = "right",
    ax_tl_s = 14,
    ax_tx_s = 11,
    y_hjust = 1,
    y_vjust = 0.5
    # axx_tx_ang = 45
  ) +
  facet_wrap(~category,
             scales = "free",
             ncol = 2)

# Save plot 
ggsave("./results/supplements/fig_S6.png",
       last_plot(),
       height = 6,
       width = 12
)


```

## Speices list

```{r}

# Number of straddling species
length(unique(prop_data$taxon_key)) #67
round(67/633 *100) #11

# Number of straddling stocks
prop_data %>% 
  group_by(hs_name,realm_name) %>% 
  summarise(x = length(unique(taxon_key)),
            .groups = "keep") %>% 
  pull(x) %>% sum() # 347

straddling_species <- prop_data %>% 
  left_join(exploited_spp) %>% 
  left_join(sau_groups #%>% rename(taxon_name = scientific_name)
  ) %>% 
  mutate(commercial_group = ifelse(is.na(commercial_group),"Other fish & inverts",commercial_group)) %>% 
  group_by(taxon_name,common_name,commercial_group) %>% 
  tally() %>% 
  select(-n)

straddling_species %>% 
  pull(commercial_group) %>% 
  unique()


write_csv(straddling_species, "./results/supplements/straddling_species.csv") # this dataset has been further updated online using thesearoundus.org


straddling_species %>% 
  mutate(
    large_pel = commercial_group %in% c("Tuna & billfishes", "Sharks & rays")
  ) %>% 
  group_by(large_pel) %>%
  tally()

# Total large pellagics
# tunas, billfishes sharks rays + mola, king of fish, wahoo, Common dolphinfish,
(34 + 4) /67

```

## RFMO / EEZ map

```{r regional_map, eval = T, echo = F}

regional_map <- ggplot() + 
  geom_sf(data = sf_rfmo %>% left_join(stradd_hs), aes(),fill = "transparent") +
  geom_sf(data = sf_meow_map, aes(fill = realm_name)) +
  # geom_sf_label(data = sf_rfmo, aes(label = rfmo_name)) +
  geom_sf(data = sf_land, aes(), fill = "antiquewhite", color = "grey50") +
  scale_fill_viridis("Region", discrete = T, option = "D") +
  # scale_color_viridis("Region", discrete = T, option = "E") +
  my_ggtheme_m(leg_pos = "right") +
  # Add RFMO labels
  geom_label_repel(data = sf_rfmo,
                   aes(label = rfmo_name,
                       geometry = geometry),
                   stat = "sf_coordinates",
                   direction = "y",
                   seed = 5,
                   max.overlaps = 10,
                   point.padding = 50,
                   hjust = "right",
                   nudge_x = 15,
                   nudge_y = ifelse(sf_rfmo$rfmo_name == "CCSBT",-20,-30),
                   alpha = 0.6,
                   size = 3
  )

# Save plot 
ggsave("./results/supplements/regional_map.png",
       regional_map,
       height = 5,
       width = 11
)

```


## Diversity map

```{r}


# Gabriel's coordinate system 
CoorG <- my_path("G","FishForVisa/Data/Spatial/","coordinates_gab.csv",read =T) %>%
  mutate(INDEX = seq(1,259200,1))

# Load FishForVisa Results
transboundary_spp <- read_csv("https://media.githubusercontent.com/media/jepa/FishForVisa/master/Data/Results/Clean_Results_Trans.csv") %>% 
  # Set same filters as in FishForVisa
  filter(
    area_index >= 0.25,
    area_index <= 1-0.25,
    model_index >= 100
  ) %>% 
  pull(taxon_key) %>% 
  unique()

#Get DBEM coords 
coords_dbem <- my_data("dbem_coords")



for(s in 1:length(transboundary_spp)){
  # for(s in 1:2){
  # Get model data from spps
  SppDist <- GetSppDist(transboundary_spp[s],Model = "All",Coord = coords_dbem)
  
  Trans_Spp <- SppDist %>%
    filter(Model != "SAU_C") %>% 
    mutate(Value = ifelse(Value > 0, 1,0)) %>%  
    group_by(TaxonKey, INDEX) %>%
    summarise(Model_Index = sum(Value,na.rm=T)/3,
              .groups = "drop") %>%
    # filter(Model_Index > 0.4) %>% # at least 2 sources agree
    # ____________ ESTIMATING FUNDAMENTAL NICHE (TRESHOLD 2)_________ #
    left_join(SppDist,
              by = c("TaxonKey","INDEX")) %>%
    filter(Model == "SAU_C", # Only keeping cells where SAU catch exists
           Value > 0) %>%
    select(index = INDEX) %>% 
    mutate(n_spp = 1) %>% 
    right_join(coords_dbem,
               by = "index")
  
  
  # ggplot(Trans_Spp) +
  #   geom_tile(
  #     aes(
  #       x = lon,
  #       y = lat,
  #       fill = n_spp
  #     )
  #   )
  
  
  if(s == 1){
    final_data <-  Trans_Spp 
  }else{
    final_data <- final_data %>% 
      left_join(Trans_Spp,
                by = "index") %>% 
      replace_na(list(n_spp.x = 0,n_spp.y = 0)) %>% 
      mutate(n_spp = n_spp.x + n_spp.y) %>% 
      select(index,n_spp)
  }
  
}

final_data %>% 
  left_join(coords_dbem) %>% 
  # filter(n_spp >0) %>% 
  ggplot() +
  # geom_contour_fill(aes(z = mean_tc, fill = stat(level)),
  # binwidth = 2)+
  metR::geom_contour_fill(
    aes(
      x = lon,
      y = lat,
      z = n_spp,
      fill = stat(level)
      # fill = n_spp,
      # color = n_spp
    ),
    binwidth = 20
  ) +
  my_ggtheme_m(leg_pos = "right") +
  geom_sf(data = sf_land, aes(), fill = "black", color = "grey50") +
  scale_fill_viridis_d("Number of species") 

ggsave("./results/supplements/fig_S1.png",
       last_plot(),
       height = 4,
       width = 9
)


```
